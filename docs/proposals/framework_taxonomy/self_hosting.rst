Self-Hosting
============

.. contents:: Contents
   :local:
   :depth: 2

Overview
--------

The Julee framework is **self-hosting**: it has the exact same structure as
solutions built on it. The framework defines the idioms, provides reusable
viewpoints and contrib modules, and uses those same idioms to structure
itself.

This isn't just philosophical elegance—it's a practical constraint that
keeps the framework honest. If the idioms are painful to use, the framework
developers feel that pain first.

Framework as Solution
---------------------

The framework is a julee solution that happens to also define what julee
solutions are::

    julee/                      # A julee solution
      core/                     # Defines the idioms (and follows them)
      hcd/                      # Viewpoint accelerator
      c4/                       # Viewpoint accelerator
      contrib/
        ceap/                   # Contrib accelerator
        polling/                # Contrib accelerator
      applications/             # How julee exposes itself
      docs/                     # Julee's own documentation
      deployment/               # How julee runs

Each accelerator (``core/``, ``hcd/``, ``c4/``, ``ceap/``, ``polling/``)
follows the same internal structure::

    {accelerator}/
      entities/
      repositories/
      use_cases/
      infrastructure/
      tests/

Solutions Mirror Framework
--------------------------

A solution built on julee has the same shape::

    my_solution/                # A julee solution
      billing/                  # Solution's accelerator
      inventory/                # Solution's accelerator
      applications/             # Solution's exposure layer
      docs/                     # Solution's documentation
      deployment/               # Solution's runtime config

The only structural difference is that solutions import from the framework
rather than defining ``core/`` and ``contrib/``:

.. code-block:: python

    # my_solution/billing/entities/invoice.py
    from julee.core.entities import BaseEntity

    class Invoice(BaseEntity):
        invoice_id: str
        amount: Decimal
        ...

Viewpoints Apply to Everything
------------------------------

Because the framework follows its own idioms, the viewpoints (HCD, C4) can
describe the framework itself:

**HCD applied to julee:**

- **Personas**: Framework developer, solution developer, end user
- **Journeys**: "Create a new accelerator", "Add an API endpoint"
- **Stories**: "As a solution developer, I want to define entities so that
  I can model my domain"

**C4 applied to julee:**

- **Containers**: The julee package, a solution package, the API server
- **Components**: ``hcd/entities``, ``applications/api``, ``core/repositories``

The framework's ``docs/`` contains these viewpoint projections—documentation
generated by applying HCD and C4 lenses to the framework's own accelerators.

Recursive Validation
--------------------

Self-hosting enables recursive validation:

1. **The framework defines validation rules** (in ``core/``)
2. **The framework validates itself** against those rules
3. **Solutions are validated** using the same rules

If a rule is added to ``core/`` that the framework itself violates, the
framework's own CI fails. This ensures rules are practical, not aspirational.

.. code-block:: python

    # core/validation/accelerator.py
    def validate_accelerator_structure(path: Path) -> list[Issue]:
        """Validate an accelerator follows the idioms."""
        issues = []
        if not (path / "entities").exists():
            issues.append(Issue(f"{path} missing entities/"))
        if not (path / "repositories").exists():
            issues.append(Issue(f"{path} missing repositories/"))
        ...
        return issues

    # Applied to framework's own accelerators
    for accel in ["core", "hcd", "c4", "contrib/ceap", "contrib/polling"]:
        issues = validate_accelerator_structure(Path(f"julee/{accel}"))
        assert not issues, f"Framework violates its own rules: {issues}"

Reusable Applications
---------------------

Framework applications are designed to work with any solution:

**Worker**: The Temporal worker is generic. Configure it with your solution's
workflows:

.. code-block:: python

    # my_solution/deployment/worker.py
    from julee.applications.worker import create_worker
    from my_solution.billing.workflows import InvoiceWorkflow
    from my_solution.inventory.workflows import StockWorkflow

    worker = create_worker(
        workflows=[InvoiceWorkflow, StockWorkflow],
        task_queue="my-solution",
    )

**Sphinx extensions**: The HCD and C4 Sphinx extensions work with any
solution that follows the idioms:

.. code-block:: python

    # my_solution/docs/conf.py
    extensions = [
        "julee.applications.sphinx.hcd",
        "julee.applications.sphinx.c4",
    ]

    # Now you can use HCD/C4 directives in your docs
    # .. define-story:: bill-001
    # .. container:: billing-service

**API patterns**: The API idioms can be instantiated for any accelerator:

.. code-block:: python

    # my_solution/applications/api/billing/app.py
    from julee.applications.api.patterns import create_crud_router
    from my_solution.billing.entities import Invoice
    from my_solution.billing.repositories import InvoiceRepository

    router = create_crud_router(
        entity=Invoice,
        repository=InvoiceRepository,
        prefix="/invoices",
    )

The Bootstrapping Question
--------------------------

How does ``core/`` follow idioms that it defines? This is the bootstrapping
problem.

The answer: ``core/`` defines *abstract* idioms (base classes, interfaces,
conventions). It follows those abstractions itself, but doesn't depend on
any specific implementations.

.. code-block:: python

    # core/entities/base.py
    from pydantic import BaseModel

    class BaseEntity(BaseModel):
        """Base class for all entities in julee solutions."""
        class Config:
            frozen = True

    # core/ itself uses BaseEntity
    # core/entities/validation_rule.py
    from .base import BaseEntity

    class ValidationRule(BaseEntity):
        rule_id: str
        description: str

``core/`` is the only accelerator that doesn't import from ``julee.core``—it
*is* ``julee.core``. All other accelerators (including framework viewpoints
and contrib modules) import from it.

Benefits of Self-Hosting
------------------------

1. **Dogfooding**: Framework developers use the same patterns as solution
   developers. Pain points are discovered and fixed early.

2. **Documentation accuracy**: The framework's docs are generated using the
   same tools solutions use. If the tools are broken, the framework's own
   docs break.

3. **Proof by example**: The framework serves as a reference implementation.
   "How do I structure an accelerator?" → Look at ``hcd/`` or ``c4/``.

4. **Constraint propagation**: Adding a constraint to ``core/`` immediately
   tests whether that constraint is practical (the framework must pass).

5. **Unified tooling**: Linters, validators, and generators work on both
   framework and solution code. One set of tools to maintain.

A Solution is a Peer
--------------------

A julee solution is not a "child" of the framework—it's a **peer**. Both
have the same shape. The solution stands on the framework's shoulders but
maintains its own posture.

::

    ┌─────────────────┐     ┌─────────────────┐
    │     julee       │     │   my_solution   │
    │  (framework)    │     │   (solution)    │
    ├─────────────────┤     ├─────────────────┤
    │ core/           │◄────│                 │
    │ hcd/            │◄────│ billing/        │
    │ c4/             │◄────│ inventory/      │
    │ contrib/        │◄────│                 │
    │ applications/   │◄────│ applications/   │
    │ docs/           │     │ docs/           │
    │ deployment/     │     │ deployment/     │
    └─────────────────┘     └─────────────────┘
           │                        │
           └────────┬───────────────┘
                    ▼
              Same structure,
              same idioms,
              same tools
